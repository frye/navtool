# ISO 8211 Binary Test Fixture Documentation

## Overview

The file `test/fixtures/iso8211/sample_enc.bin` is a binary test fixture that contains a minimal but realistic ISO 8211 structure for testing the multi-record parser implementation.

## Fixture Structure

The fixture contains 4 records totaling 248 bytes:

### Record 1: DDR (Directory Definition Record) - 72 bytes
- **Type**: `L` (DDR Leader Identifier)
- **Base Address**: 53 (field area starts at byte 53 from record start)
- **Fields**:
  - `DSID`: Chart identifier "US5WA50M" (8 bytes)
  - `DSPM`: Date stamp "20241201" (8 bytes)

### Record 2: Data Record A - 71 bytes  
- **Type**: `D` (Data Record)
- **Base Address**: 53
- **Fields**:
  - `FOID`: Feature Object ID "001" (3 bytes)
  - `FT01`: Feature data "BCNCAR\u001f02\u001f01" (10 bytes with subfield delimiters)

### Record 3: Data Record B - 55 bytes
- **Type**: `D` (Data Record)  
- **Base Address**: 39
- **Fields**:
  - `FT02`: Feature data "SOUNDG\u001f150\u001f250" (13 bytes with depth values)

### Record 4: Malformed Record - 50 bytes
- **Type**: `D` (Data Record)
- **Base Address**: 10 (INVALID - less than leader size of 24)
- **Purpose**: Tests error recovery - this record should be skipped with a warning

## Binary Structure Details

Each record follows the ISO 8211 specification:

### Leader (24 bytes)
```
Positions 0-4:   Record length (5 ASCII digits)
Position 5:      Interchange level 
Position 6:      Leader identifier (L=DDR, D=Data)
Position 7:      Field control length
Positions 8-12:  Base address of field area (5 ASCII digits)
Positions 13-15: Extended character set indicator
Position 16:     Size of field length indicator (5)
Position 17:     Size of field position indicator (5)  
Position 18:     Reserved
Position 19:     Size of field tag indicator (4)
Positions 20-23: Reserved
```

### Directory
Variable-length sequence of entries, each containing:
- Field tag (4 bytes): e.g., "DSID", "FOID"
- Field length (5 bytes): Length of field data
- Field position (5 bytes): Offset from field area start
- Directory terminator: 0x1E

### Field Area
- Raw field data bytes
- Each field terminated by 0x1E (field terminator)
- Subfields within a field separated by 0x1F (subfield delimiter)

### Record Termination
- Each record ends with 0x1D (record terminator)

## Test Scenarios Covered

1. **Valid DDR Parsing**: Tests metadata extraction from the first record
2. **Valid Data Record Parsing**: Tests feature field extraction from records 2 and 3
3. **Directory Offset Validation**: Ensures field positions are calculated correctly
4. **Subfield Delimiter Handling**: Tests parsing of composite fields like "BCNCAR\u001f02\u001f01"
5. **Malformed Record Recovery**: Tests graceful handling of the invalid fourth record
6. **Multi-Record Iteration**: Tests that the reader can process all records sequentially

## Generation

The fixture is generated by the script `tools/generate_iso8211_fixture.dart` which creates the binary structure programmatically and includes verification output.

To regenerate the fixture:
```bash
dart run tools/generate_iso8211_fixture.dart
```

## Usage in Tests

The fixture is used by:
- `iso8211_reader_valid_test.dart` - Tests successful parsing
- `iso8211_reader_malformed_test.dart` - Tests error handling 
- `iso8211_directory_offsets_test.dart` - Tests precise offset calculations
- `s57_raw_field_pipeline_test.dart` - Integration testing

## Expected Test Results

When processed by `Iso8211Reader`:
- **Records parsed**: 3 (DDR + 2 data records)
- **Records skipped**: 1 (malformed record)
- **Warnings generated**: 1 (bad base address warning)
- **Total fields extracted**: 5 (DSID, DSPM, FOID, FT01, FT02)

This fixture provides comprehensive coverage for the core ISO 8211 parsing requirements while remaining small and manageable for testing purposes.